<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="sidebar">
        <h2 class="sidebar-header">USB ê´€ë¦¬ ì½˜ì†”</h2>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="index.html"><span>ğŸ </span> ëª¨ë‹ˆí„°ë§</a></li>
                <li><a href="whitelist.html" class="active"><span>âœ…</span> í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬</a></li>
                <li><a href="#"><span>ğŸ“„</span> ë¡œê·¸ ê¸°ë¡</a></li>
                <li><a href="#"><span>âš™ï¸</span> ì„¤ì •</a></li>
            </ul>
        </nav>
    </div>

    <div class="main-content">
        <header class="main-header">
            <h1>í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬</h1>
        </header>
        
        <main>
            <div class="card">
                <h3 class="card-header">USB ì¥ì¹˜ ë“±ë¡</h3>
                <form class="whitelist-form">
                    <input type="text" placeholder="USB ì‹œë¦¬ì–¼ ë„˜ë²„ (S/N)" required class="form-input">
                    <input type="text" placeholder="ì„¤ëª… (ì˜ˆ: ê°œë°œíŒ€ ê³µìš© USB)" class="form-input">
                    <button type="submit" class="btn btn-primary">ë“±ë¡</button>
                </form>
            </div>

            <div class="card">
                <h3 class="card-header">ì €ì¥ëœ ì¥ì¹˜ ëª©ë¡ (ìµœê·¼ ì´ë²¤íŠ¸)</h3>
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>ì¥ì¹˜ëª…</th>
                            <th>VID/PID</th>
                            <th>í—ˆìš©ì—¬ë¶€</th>
                            <th>ë°œê²¬ì‹œê°„(UTC)</th>
                            <th>ConnectionId</th>
                            <th>ì‚­ì œ</th>
                        </tr>
                    </thead>
                    <tbody id="event-body">
                        <tr><td colspan="5">ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        async function loadEvents() {
            const body = document.getElementById('event-body');
            body.innerHTML = '<tr><td colspan="5">ë¡œë”© ì¤‘...</td></tr>';
            try {
                const res = await fetch('/api/usb-events?take=200');
                if (!res.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                const data = await res.json();
                if (!Array.isArray(data) || data.length === 0) {
                    body.innerHTML = '<tr><td colspan="5">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }
                body.innerHTML = data.map(d => {
                    const vid = Number(d.vendorId).toString(16).padStart(4, '0').toUpperCase();
                    const pid = Number(d.productId).toString(16).padStart(4, '0').toUpperCase();
                    const allowed = d.isBlocked ? 'ì°¨ë‹¨' : 'í—ˆìš©';
                    const name = d.productString || d.manufacturerString || '(ì´ë¦„ ì—†ìŒ)';
                    const detected = d.detectedAt ?? '';
                    const conn = d.connectionId ?? '';
                    return `<tr>
                        <td>${escapeHtml(name)}</td>
                        <td>VID:${vid} / PID:${pid}</td>
                        <td>${allowed}</td>
                        <td>${escapeHtml(detected)}</td>
                        <td>${escapeHtml(conn)}</td>
                        <td><button class="btn btn-danger" data-id="${d.id}">ì‚­ì œ</button></td>
                    </tr>`;
                }).join('');
                attachDeleteHandlers();
            } catch (err) {
                body.innerHTML = `<tr><td colspan="5">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${err.message}</td></tr>`;
            }
        }

        function escapeHtml(str) {
            return String(str).replace(/[&<>"']/g, c => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[c] || c));
        }

        function attachDeleteHandlers() {
            const body = document.getElementById('event-body');
            body.querySelectorAll('button[data-id]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                    if (!id) return;
                    const ok = confirm(`ì´ ì´ë²¤íŠ¸(ID: ${id})ë¥¼ ì‚­ì œí• ê¹Œìš”?`);
                    if (!ok) return;
                    btn.disabled = true;
                    try {
                        const res = await fetch(`/api/usb-events/${id}`, { method: 'DELETE' });
                        if (!res.ok && res.status !== 204) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
                        await loadEvents();
                    } catch (err) {
                        alert(`ì‚­ì œ ì‹¤íŒ¨: ${err.message}`);
                        btn.disabled = false;
                    }
                });
            });
        }

        document.addEventListener('DOMContentLoaded', loadEvents);
    </script>
</body>
</html>
